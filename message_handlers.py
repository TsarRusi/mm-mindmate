"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è MindMate Bot
–ü–û–õ–ù–ê–Ø –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ö–ù–û–ü–ö–ê–ú–ò
"""

import logging
import random
from datetime import datetime
from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes

logger = logging.getLogger(__name__)

# ============ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ============

def get_main_keyboard():
    """–û—Å–Ω–æ–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞"""
    keyboard = [
        ["üìä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ", "üí¨ –ß–∞—Ç —Å –ò–ò"],
        ["üßò –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è", "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"],
        ["‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "‚ùì –ü–æ–º–æ—â—å"]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True, selective=True)

def get_mood_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è"""
    keyboard = [
        ["1 üò≠", "2 üò¢", "3 üòî", "4 üòï", "5 üòê"],
        ["6 üôÇ", "7 üëç", "8 üòä", "9 ü§©", "10 üòç"],
        ["‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

def get_exercises_keyboard():
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π"""
    keyboard = [
        ["üßò –î—ã—Ö–∞–Ω–∏–µ", "üåø –ú–µ–¥–∏—Ç–∞—Ü–∏—è"],
        ["üí™ –†–µ–ª–∞–∫—Å–∞—Ü–∏—è", "üìù –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å"],
        ["üéµ –ú—É–∑—ã–∫–∞", "‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"]
    ]
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

def get_stats_inline_keyboard():
    """Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    keyboard = [
        [
            InlineKeyboardButton("üìÖ –°–µ–≥–æ–¥–Ω—è", callback_data="stats_today"),
            InlineKeyboardButton("üìÜ –ù–µ–¥–µ–ª—è", callback_data="stats_week")
        ],
        [
            InlineKeyboardButton("üóìÔ∏è –ú–µ—Å—è—Ü", callback_data="stats_month"),
            InlineKeyboardButton("üìä –í—Å–µ –≤—Ä–µ–º—è", callback_data="stats_all")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

# ============ –û–°–ù–û–í–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ============

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    try:
        user = update.effective_user
        
        # –ö—Ä–∞—Å–∏–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º
        welcome_text = f"""
‚ú® *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MindMate, {user.first_name}!* ‚ú®

üåà *–Ø –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫*

üéØ *–ß—Ç–æ —è —É–º–µ—é:*
‚Ä¢ üìä –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ –≤–∞—à–µ–º—É —Ç–µ–∫—Å—Ç—É
‚Ä¢ üí¨ –û–±—â–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ —É–º–Ω—ã–π –ò–ò-—á–∞—Ç
‚Ä¢ üßò –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –¥–ª—è —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏
‚Ä¢ üìà –í–µ–¥–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–∞—à–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
‚Ä¢ üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å

üìå *–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã:*
/start - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
/help - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
/mood - –û—Ü–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
/stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/chat - –ß–∞—Ç —Å –ò–ò
/crisis - –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å

üíñ *–ü–æ–º–Ω–∏—Ç–µ: –≤–∞—à–µ –ø—Å–∏—Ö–∏—á–µ—Å–∫–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ –≤–∞–∂–Ω–æ!*
        """
        
        await update.message.reply_text(
            welcome_text,
            reply_markup=get_main_keyboard(),
            parse_mode='Markdown'
        )
        logger.info(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user.id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ start: {e}")
        await update.message.reply_text(
            "‚ú® *MindMate Bot –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!*\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /help",
            parse_mode='Markdown'
        )

async def show_help(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    try:
        help_text = """
üìö *–ü–û–ú–û–©–¨ –ü–û MINDMATE BOT*

üéÆ *–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å:*
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
2. –ò–ª–∏ –ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã –≤—Ä—É—á–Ω—É—é
3. –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –æ —Å–≤–æ–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ - —è –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é!

üéØ *–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:*

üìä *–ù–ê–°–¢–†–û–ï–ù–ò–ï*
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "üìä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ"
‚Ä¢ –ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ
‚Ä¢ –Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç –∏ –¥–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

üí¨ *–ß–ê–¢ –° –ò–ò*
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üí¨ –ß–∞—Ç —Å –ò–ò"
‚Ä¢ –û–±—Å—É–¥–∏—Ç–µ –ª—é–±—É—é —Ç–µ–º—É —Å —É–º–Ω—ã–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º
‚Ä¢ –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ —Å–æ–≤–µ—Ç

üßò *–£–ü–†–ê–ñ–ù–ï–ù–ò–Ø*
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üßò –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"
‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Ö–Ω–∏–∫—É —Ä–µ–ª–∞–∫—Å–∞—Ü–∏–∏
‚Ä¢ –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º

üìà *–°–¢–ê–¢–ò–°–¢–ò–ö–ê*
‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
‚Ä¢ –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥
‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥–∏–Ω–∞–º–∏–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è

‚öôÔ∏è *–ù–ê–°–¢–†–û–ô–ö–ò*
‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚Ä¢ –ò–∑–º–µ–Ω–∏—Ç–µ —Ç–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

‚ùì *–ü–û–ú–û–©–¨*
‚Ä¢ –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
‚Ä¢ –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏

üìû *–≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å:*
/crisis - —Ç–µ–ª–µ—Ñ–æ–Ω—ã –¥–æ–≤–µ—Ä–∏—è –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã

üí° *–°–æ–≤–µ—Ç:* –ß–∞—â–µ –¥–µ–ª–∏—Ç–µ—Å—å —Å–≤–æ–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º - —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å!
        """
        
        await update.message.reply_text(
            help_text,
            reply_markup=get_main_keyboard(),
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ show_help: {e}")
        await update.message.reply_text(
            "üìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
            "/start /help /mood /stats /chat /crisis",
            parse_mode='Markdown'
        )

# ============ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ============

async def handle_mood_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ"""
    try:
        text = """
üìä *–ê–ù–ê–õ–ò–ó –ù–ê–°–¢–†–û–ï–ù–ò–Ø*

–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:

1Ô∏è‚É£ *–û—Ü–µ–Ω–∏—Ç—å —Ü–∏—Ñ—Ä–æ–π* - –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å —Ü–∏—Ñ—Ä–æ–π –æ—Ç 1 –¥–æ 10
2Ô∏è‚É£ *–û—Ü–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–º* - –Ω–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ
3Ô∏è‚É£ *–ü–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑* - –æ–ø–∏—à–∏—Ç–µ —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ

üéØ *–ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π:*
‚Ä¢ "–°–µ–≥–æ–¥–Ω—è —á—É–≤—Å—Ç–≤—É—é —Å–µ–±—è —É—Å—Ç–∞–≤—à–∏–º"
‚Ä¢ "–£ –º–µ–Ω—è —Å—Ç—Ä–µ—Å—Å –Ω–∞ —Ä–∞–±–æ—Ç–µ"
‚Ä¢ "–Ø —Å—á–∞—Å—Ç–ª–∏–≤, –≤—Å–µ —Ö–æ—Ä–æ—à–æ!"
‚Ä¢ "–ß—É–≤—Å—Ç–≤—É—é —Ç—Ä–µ–≤–æ–≥—É –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã"

üí° *–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à —Ç–µ–∫—Å—Ç –∏ –¥–∞–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!*
        """
        
        await update.message.reply_text(
            text,
            reply_markup=get_mood_keyboard(),
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_mood_button: {e}")
        await update.message.reply_text(
            "üìä –î–ª—è –æ—Ü–µ–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ",
            reply_markup=get_mood_keyboard()
        )

async def handle_ai_chat_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ß–∞—Ç —Å –ò–ò"""
    try:
        text = """
üí¨ *–ß–ê–¢ –° –ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ú –ò–ù–¢–ï–õ–õ–ï–ö–¢–û–ú*

ü§ñ *–Ø –∑–¥–µ—Å—å —á—Ç–æ–±—ã:*
‚Ä¢ –í—ã—Å–ª—É—à–∞—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å
‚Ä¢ –ü–æ–º–æ—á—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —á—É–≤—Å—Ç–≤–∞—Ö
‚Ä¢ –î–∞—Ç—å –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
‚Ä¢ –ü—Ä–æ—Å—Ç–æ –ø–æ–≥–æ–≤–æ—Ä–∏—Ç—å –Ω–∞ –ª—é–±—É—é —Ç–µ–º—É

üìù *–ö–∞–∫ –Ω–∞—á–∞—Ç—å:*
–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–≤–æ–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏!

üéØ *–ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º:*
‚Ä¢ "–ö–∞–∫ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º?"
‚Ä¢ "–ß—É–≤—Å—Ç–≤—É—é –æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ, —á—Ç–æ –¥–µ–ª–∞—Ç—å?"
‚Ä¢ "–ü–æ–º–æ–≥–∏—Ç–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö"
‚Ä¢ "–ö–∞–∫ —Å—Ç–∞—Ç—å –±–æ–ª–µ–µ —É–≤–µ—Ä–µ–Ω–Ω—ã–º?"

‚ú® *–ü–∏—à–∏—Ç–µ - —è –≥–æ—Ç–æ–≤ –≤–∞—Å –≤—ã—Å–ª—É—à–∞—Ç—å!*
        """
        
        await update.message.reply_text(
            text,
            parse_mode='Markdown'
        )
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ —á–∞—Ç–∞
        context.user_data['in_ai_chat'] = True
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_ai_chat_button: {e}")
        await update.message.reply_text("üí¨ –ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –¥–ª—è –ò–ò")

async def handle_exercises_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"""
    try:
        text = """
üßò *–£–ü–†–ê–ñ–ù–ï–ù–ò–Ø –î–õ–Ø –†–ï–õ–ê–ö–°–ê–¶–ò–ò*

–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è:

üßò *–î–´–•–ê–ù–ò–ï 4-7-8*
‚Ä¢ –í–¥–æ—Ö –Ω–∞ 4 —Å–µ–∫—É–Ω–¥—ã
‚Ä¢ –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ 7 —Å–µ–∫—É–Ω–¥
‚Ä¢ –í—ã–¥–æ—Ö –Ω–∞ 8 —Å–µ–∫—É–Ω–¥
‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å 5 —Ä–∞–∑

üåø *–ú–ï–î–ò–¢–ê–¶–ò–Ø 5 –ú–ò–ù–£–¢*
1. –°—è–¥—å—Ç–µ —É–¥–æ–±–Ω–æ
2. –ó–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞
3. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –¥—ã—Ö–∞–Ω–∏–µ–º
4. –í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, –∫–æ–≥–¥–∞ –º—ã—Å–ª–∏ —É—Ö–æ–¥—è—Ç

üí™ *–ü–†–û–ì–†–ï–°–°–ò–í–ù–ê–Ø –†–ï–õ–ê–ö–°–ê–¶–ò–Ø*
‚Ä¢ –ù–∞–ø—Ä—è–≥–∏—Ç–µ –∏ —Ä–∞—Å—Å–ª–∞–±—å—Ç–µ –º—ã—à—Ü—ã –æ—Ç –ª–∏—Ü–∞ –¥–æ –Ω–æ–≥
‚Ä¢ –ü–æ 5 —Å–µ–∫—É–Ω–¥ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ, 10 —Å–µ–∫—É–Ω–¥ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ

üìù *–î–ù–ï–í–ù–ò–ö –ë–õ–ê–ì–û–î–ê–†–ù–û–°–¢–ò*
‚Ä¢ –ó–∞–ø–∏—à–∏—Ç–µ 3 –≤–µ—â–∏, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ –û–ø–∏—à–∏—Ç–µ, –ø–æ—á–µ–º—É –æ–Ω–∏ –≤–∞–∂–Ω—ã

üéµ *–ú–£–ó–´–ö–ê –î–õ–Ø –†–ï–õ–ê–ö–°–ê–¶–ò–ò*
‚Ä¢ –í–∫–ª—é—á–∏—Ç–µ —Å–ø–æ–∫–æ–π–Ω—É—é –º—É–∑—ã–∫—É
‚Ä¢ –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –∑–≤—É–∫–∞—Ö
‚Ä¢ –î—ã—à–∏—Ç–µ –≥–ª—É–±–æ–∫–æ

–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç!
        """
        
        await update.message.reply_text(
            text,
            reply_markup=get_exercises_keyboard(),
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_exercises_button: {e}")
        await update.message.reply_text(
            "üßò –í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞",
            reply_markup=get_exercises_keyboard()
        )

async def handle_stats_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"""
    try:
        text = """
üìà *–í–ê–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê*

–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏–∫–∞ –≤–∞—à–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å.

üéØ *–ß—Ç–æ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å:*
‚Ä¢ –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚Ä¢ –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ–º—ã

üìä *–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥:*
        """
        
        await update.message.reply_text(
            text,
            reply_markup=get_stats_inline_keyboard(),
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_stats_button: {e}")
        await update.message.reply_text(
            "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞–ø–∏—Å–µ–π"
        )

async def handle_settings_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏"""
    try:
        text = """
‚öôÔ∏è *–ù–ê–°–¢–†–û–ô–ö–ò*

üîî *–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:* –í–∫–ª—é—á–µ–Ω—ã
üåô *–¢–µ–º–∞:* –°–≤–µ—Ç–ª–∞—è
üîí *–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å:* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è
üíæ *–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ:* –î–∞

‚ö° *–ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:*
‚Ä¢ /notifications - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
‚Ä¢ /theme - –°–º–µ–Ω–∞ —Ç–µ–º—ã
‚Ä¢ /privacy - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏

üì± *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/notifications - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
/export - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
/clear - –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏

üé® *–°–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è:*
‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è—Ö
‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º
        """
        
        await update.message.reply_text(
            text,
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_settings_button: {e}")
        await update.message.reply_text("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö")

async def handle_back_button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥"""
    try:
        await update.message.reply_text(
            "‚Ü©Ô∏è *–í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª:",
            reply_markup=get_main_keyboard(),
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_back_button: {e}")

# ============ –û–ë–†–ê–ë–û–¢–ß–ò–ö –¢–ï–ö–°–¢–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô ============

async def handle_text_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –í–°–ï–• —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        user_text = update.message.text
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –æ—Ü–µ–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è —Ü–∏—Ñ—Ä–æ–π
        if user_text in ["1 üò≠", "2 üò¢", "3 üòî", "4 üòï", "5 üòê", "6 üôÇ", "7 üëç", "8 üòä", "9 ü§©", "10 üòç"]:
            mood_score = user_text.split()[0]
            await handle_mood_rating(update, context, mood_score)
            return
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
        if user_text in ["‚Ü©Ô∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", "‚Ü©Ô∏è –ù–∞–∑–∞–¥"]:
            await handle_back_button(update, context)
            return
            
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        if user_text in ["üßò –î—ã—Ö–∞–Ω–∏–µ", "üåø –ú–µ–¥–∏—Ç–∞—Ü–∏—è", "üí™ –†–µ–ª–∞–∫—Å–∞—Ü–∏—è", "üìù –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å", "üéµ –ú—É–∑—ã–∫–∞"]:
            await handle_specific_exercise(update, context, user_text)
            return
            
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ AI —á–∞—Ç–∞
        if context.user_data.get('in_ai_chat'):
            await handle_ai_response(update, context, user_text)
            return
            
        # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        await analyze_mood_text(update, context, user_text)
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_text_message: {e}")
        await update.message.reply_text(
            "‚ö†Ô∏è *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏*\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start",
            parse_mode='Markdown'
        )

# ============ –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ============

async def handle_mood_rating(update: Update, context: ContextTypes.DEFAULT_TYPE, score: str):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ü–µ–Ω–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è —Ü–∏—Ñ—Ä–æ–π"""
    try:
        mood_emojis = {
            "1": "üò≠", "2": "üò¢", "3": "üòî", 
            "4": "üòï", "5": "üòê", "6": "üôÇ",
            "7": "üëç", "8": "üòä", "9": "ü§©", "10": "üòç"
        }
        
        mood_responses = {
            "1-3": "üíî *–û—á–µ–Ω—å —Ç—è–∂–µ–ª—ã–π –¥–µ–Ω—å*\n\n–†–µ–∫–æ–º–µ–Ω–¥—É—é:\n‚Ä¢ –ü–æ–∑–≤–æ–Ω–∏—Ç—å –±–ª–∏–∑–∫–æ–º—É\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É –¥—ã—Ö–∞–Ω–∏—è\n‚Ä¢ –ö–æ–º–∞–Ω–¥–∞ /crisis –µ—Å–ª–∏ –Ω—É–∂–Ω–æ",
            "4-5": "üåßÔ∏è *–°–ª–æ–∂–Ω—ã–π –¥–µ–Ω—å*\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –ö–æ—Ä–æ—Ç–∫—É—é –ø—Ä–æ–≥—É–ª–∫—É\n‚Ä¢ –ó–∞–ø–∏—Å–∞—Ç—å –º—ã—Å–ª–∏\n‚Ä¢ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è /exercises",
            "6-7": "üå§Ô∏è *–ù–µ–ø–ª–æ—Ö–æ–π –¥–µ–Ω—å*\n\n–°–æ–≤–µ—Ç:\n‚Ä¢ –û—Ç–º–µ—Ç—å—Ç–µ —á—Ç–æ-—Ç–æ —Ö–æ—Ä–æ—à–µ–µ\n‚Ä¢ –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏—Ç–µ —Å–µ–±—è\n‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ!",
            "8-10": "üåà *–û—Ç–ª–∏—á–Ω—ã–π –¥–µ–Ω—å!*\n\n–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ!\n‚Ä¢ –ó–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Ä–∞–¥–æ—Å—Ç–∏\n‚Ä¢ –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å –¥—Ä—É–≥–∏–º–∏\n‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
        }
        
        emoji = mood_emojis.get(score, "üòê")
        score_int = int(score)
        
        if score_int <= 3:
            response_key = "1-3"
        elif score_int <= 5:
            response_key = "4-5"
        elif score_int <= 7:
            response_key = "6-7"
        else:
            response_key = "8-10"
        
        response = f"""
üéØ *–û–¶–ï–ù–ö–ê –ù–ê–°–¢–†–û–ï–ù–ò–Ø: {score}/10* {emoji}

{mood_responses[response_key]}

üìù *–•–æ—Ç–∏—Ç–µ –æ–ø–∏—Å–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?*
–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã–∑–≤–∞–ª–æ —Ç–∞–∫–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ.
        """
        
        await update.message.reply_text(
            response,
            reply_markup=get_main_keyboard(),
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_mood_rating: {e}")

async def handle_specific_exercise(update: Update, context: ContextTypes.DEFAULT_TYPE, exercise: str):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è"""
    try:
        exercises = {
            "üßò –î—ã—Ö–∞–Ω–∏–µ": """
üå¨Ô∏è *–¢–ï–•–ù–ò–ö–ê –î–´–•–ê–ù–ò–Ø 4-7-8*

üéØ *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –°—è–¥—å—Ç–µ –ø—Ä—è–º–æ –∏–ª–∏ –ª—è–≥—Ç–µ
2. –ü–æ–ª–æ–∂–∏—Ç–µ –æ–¥–Ω—É —Ä—É–∫—É –Ω–∞ –≥—Ä—É–¥—å, –¥—Ä—É–≥—É—é –Ω–∞ –∂–∏–≤–æ—Ç
3. –í–¥–æ—Ö–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ –Ω–æ—Å –Ω–∞ 4 —Å–µ–∫—É–Ω–¥—ã
4. –ó–∞–¥–µ—Ä–∂–∏—Ç–µ –¥—ã—Ö–∞–Ω–∏–µ –Ω–∞ 7 —Å–µ–∫—É–Ω–¥
5. –ú–µ–¥–ª–µ–Ω–Ω–æ –≤—ã–¥–æ—Ö–Ω–∏—Ç–µ —á–µ—Ä–µ–∑ —Ä–æ—Ç –Ω–∞ 8 —Å–µ–∫—É–Ω–¥

‚è∞ *–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ 5 —Ä–∞–∑*
üí° *–≠—Ñ—Ñ–µ–∫—Ç:* –°–Ω–∏–∂–µ–Ω–∏–µ —Ç—Ä–µ–≤–æ–≥–∏, —É–ª—É—á—à–µ–Ω–∏–µ —Å–Ω–∞
            """,
            "üåø –ú–µ–¥–∏—Ç–∞—Ü–∏—è": """
üß† *5-–ú–ò–ù–£–¢–ù–ê–Ø –ú–ï–î–ò–¢–ê–¶–ò–Ø*

üéØ *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –ù–∞–π–¥–∏—Ç–µ —Ç–∏—Ö–æ–µ –º–µ—Å—Ç–æ
2. –°—è–¥—å—Ç–µ —É–¥–æ–±–Ω–æ, —Å–ø–∏–Ω–∞ –ø—Ä—è–º–∞—è
3. –ó–∞–∫—Ä–æ–π—Ç–µ –≥–ª–∞–∑–∞
4. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Ç–µ—Å—å –Ω–∞ –¥—ã—Ö–∞–Ω–∏–∏
5. –ö–æ–≥–¥–∞ –º—ã—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç - –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –¥—ã—Ö–∞–Ω–∏—é

‚è∞ *5 –º–∏–Ω—É—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å*
üí° *–≠—Ñ—Ñ–µ–∫—Ç:* –£–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, —Å–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç—Ä–µ—Å—Å–∞
            """,
            "üí™ –†–µ–ª–∞–∫—Å–∞—Ü–∏—è": """
üõå *–ü–†–û–ì–†–ï–°–°–ò–í–ù–ê–Ø –ú–´–®–ï–ß–ù–ê–Ø –†–ï–õ–ê–ö–°–ê–¶–ò–Ø*

üéØ *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –õ—è–≥—Ç–µ —É–¥–æ–±–Ω–æ
2. –ù–∞–ø—Ä—è–≥–∏—Ç–µ –º—ã—à—Ü—ã –ª–∏—Ü–∞ –Ω–∞ 5 —Å–µ–∫ ‚Üí —Ä–∞—Å—Å–ª–∞–±—å—Ç–µ
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ —à–µ–µ, –ø–ª–µ—á–∞–º, —Ä—É–∫–∞–º
4. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –¥–æ –Ω–æ–≥
5. –ü–æ—á—É–≤—Å—Ç–≤—É–π—Ç–µ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ–º –∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ–º

‚è∞ *15-20 –º–∏–Ω—É—Ç*
üí° *–≠—Ñ—Ñ–µ–∫—Ç:* –ì–ª—É–±–æ–∫–æ–µ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ, —Å–Ω—è—Ç–∏–µ –º—ã—à–µ—á–Ω—ã—Ö –∑–∞–∂–∏–º–æ–≤
            """,
            "üìù –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å": """
üôè *–î–ù–ï–í–ù–ò–ö –ë–õ–ê–ì–û–î–ê–†–ù–û–°–¢–ò*

üéØ *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –í–æ–∑—å–º–∏—Ç–µ –±–ª–æ–∫–Ω–æ—Ç –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –∑–∞–º–µ—Ç–∫–∏
2. –ó–∞–ø–∏—à–∏—Ç–µ 3 –≤–µ—â–∏, –∑–∞ –∫–æ—Ç–æ—Ä—ã–µ –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –°–ï–ì–û–î–ù–Ø
3. –û–ø–∏—à–∏—Ç–µ –ü–û–ß–ï–ú–£ –≤—ã –∑–∞ –Ω–∏—Ö –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã
4. –ü–æ—á—É–≤—Å—Ç–≤—É–π—Ç–µ —ç–º–æ—Ü–∏–∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

üìñ *–ü—Ä–∏–º–µ—Ä:*
‚Ä¢ "–ë–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ —É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ—Ñ–µ - –æ–Ω –¥–∞–ª —ç–Ω–µ—Ä–≥–∏—é"
‚Ä¢ "–ë–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥—Ä—É–≥–∞"
‚Ä¢ "–ë–ª–∞–≥–æ–¥–∞—Ä–µ–Ω –∑–∞ —Å–æ–ª–Ω–µ—á–Ω—É—é –ø–æ–≥–æ–¥—É"

üí° *–≠—Ñ—Ñ–µ–∫—Ç:* –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å—á–∞—Å—Ç—å—è, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ–∫—É—Å–∞
            """,
            "üéµ –ú—É–∑—ã–∫–∞": """
üé∂ *–ú–£–ó–´–ö–ê –î–õ–Ø –†–ï–õ–ê–ö–°–ê–¶–ò–ò*

üéØ *–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:*
1. –ù–∞–π–¥–∏—Ç–µ —Å–ø–æ–∫–æ–π–Ω—É—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–ª—å–Ω—É—é –º—É–∑—ã–∫—É
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞—É—à–Ω–∏–∫–∏ –¥–ª—è –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è
3. –°—è–¥—å—Ç–µ –∏–ª–∏ –ª—è–≥—Ç–µ —É–¥–æ–±–Ω–æ
4. –°–ª—É—à–∞–π—Ç–µ, —Å–æ—Å—Ä–µ–¥–æ—Ç–∞—á–∏–≤–∞—è—Å—å –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö
5. –î—ã—à–∏—Ç–µ –≤ —Ä–∏—Ç–º–µ –º—É–∑—ã–∫–∏

üéµ *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:*
‚Ä¢ –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –º—É–∑—ã–∫–∞
‚Ä¢ –ó–≤—É–∫–∏ –ø—Ä–∏—Ä–æ–¥—ã
‚Ä¢ –ú–µ–¥–∏—Ç–∞—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–∫–∏
‚Ä¢ –ë–∏–Ω–∞—É—Ä–∞–ª—å–Ω—ã–µ —Ä–∏—Ç–º—ã

üí° *–≠—Ñ—Ñ–µ–∫—Ç:* –°–Ω–∏–∂–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è, —É–ª—É—á—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
            """
        }
        
        await update.message.reply_text(
            exercises.get(exercise, "–í—ã–±–µ—Ä–∏—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞"),
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_specific_exercise: {e}")

async def handle_ai_response(update: Update, context: ContextTypes.DEFAULT_TYPE, user_text: str):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò"""
    try:
        # –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ –ò–ò (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã API –≤—ã–∑–æ–≤)
        ai_responses = [
            "üí≠ *–Ø –ø–æ–Ω–∏–º–∞—é –≤–∞—à–∏ —á—É–≤—Å—Ç–≤–∞.*\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–∏—Ç—É–∞—Ü–∏—é —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã. –ß–∞—Å—Ç–æ –Ω–∞—à–∏ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è –∫–∞–∂—É—Ç—Å—è –±–æ–ª—å—à–µ, —á–µ–º –æ–Ω–∏ –µ—Å—Ç—å –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ.",
            "ü§ó *–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–¥–µ–ª–∏–ª–∏—Å—å.*\n\n–í–∞–∂–Ω–æ –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å —Å–≤–æ–∏ —ç–º–æ—Ü–∏–∏. –≠—Ç–æ –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ –∏—Ö –ø–æ–Ω–∏–º–∞–Ω–∏—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é.",
            "üåü *–ò–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –º—ã—Å–ª—å.*\n\n–ê —á—Ç–æ –µ—Å–ª–∏ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ–±—ã—Ç–∏–π?",
            "üí™ *–í—ã —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –¥—É–º–∞–µ—Ç–µ.*\n\n–ü–æ–º–Ω–∏—Ç–µ –æ —Å–≤–æ–∏—Ö –ø—Ä–æ—à–ª—ã—Ö —É—Å–ø–µ—Ö–∞—Ö –≤ —Å–ª–æ–∂–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö.",
            "üåà *–ö–∞–∂–¥–∞—è —ç–º–æ—Ü–∏—è –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ.*\n\n–î–∞–∂–µ —Ç—Ä—É–¥–Ω—ã–µ —á—É–≤—Å—Ç–≤–∞ –º–æ–≥—É—Ç —á–µ–º—É-—Ç–æ –Ω–∞—É—á–∏—Ç—å."
        ]
        
        response = f"""
üí¨ *–í–æ–ø—Ä–æ—Å:* "{user_text[:50]}..."

{random.choice(ai_responses)}

‚ú® *–ß—Ç–æ –¥–∞–ª—å—à–µ?*
‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ –¥–∏–∞–ª–æ–≥
‚Ä¢ –ò–ª–∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ –º–µ–Ω—é /start
        """
        
        await update.message.reply_text(
            response,
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_ai_response: {e}")

async def analyze_mood_text(update: Update, context: ContextTypes.DEFAULT_TYPE, user_text: str):
    """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è"""
    try:
        # –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        positive_words = ['—Ö–æ—Ä–æ—à–æ', '–æ—Ç–ª–∏—á–Ω–æ', '—Ä–∞–¥', '—Å—á–∞—Å—Ç–ª–∏–≤', '–ø—Ä–µ–∫—Ä–∞—Å–Ω–æ', '–∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ']
        negative_words = ['–ø–ª–æ—Ö–æ', '–≥—Ä—É—Å—Ç–Ω–æ', '—É—Å—Ç–∞–ª', '—Å—Ç—Ä–µ—Å—Å', '—Ç—Ä–µ–≤–æ–≥–∞', '–±–µ—Å–ø–æ–∫–æ–π—Å—Ç–≤–æ']
        
        text_lower = user_text.lower()
        positive_count = sum(1 for word in positive_words if word in text_lower)
        negative_count = sum(1 for word in negative_words if word in text_lower)
        
        if positive_count > negative_count:
            sentiment = "POSITIVE"
            emoji = "üòä"
            advice = "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ. –ó–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –≤—ã–∑–≤–∞–ª–æ —ç—Ç–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏."
        elif negative_count > positive_count:
            sentiment = "NEGATIVE"
            emoji = "ü§ó"
            advice = "–ü–æ—Ö–æ–∂–µ, –≤–∞–º —Ç—è–∂–µ–ª–æ. –†–µ–∫–æ–º–µ–Ω–¥—É—é —Ç–µ—Ö–Ω–∏–∫—É –¥—ã—Ö–∞–Ω–∏—è –∏–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –±–ª–∏–∑–∫–∏–º. –ö–æ–º–∞–Ω–¥–∞ /crisis –µ—Å–ª–∏ –Ω—É–∂–Ω–æ."
        else:
            sentiment = "NEUTRAL"
            emoji = "üòê"
            advice = "–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - –æ—Ç–ª–∏—á–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è —Å–∞–º–æ–∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è /exercises"
        
        response = f"""
üîç *–ê–ù–ê–õ–ò–ó –í–ê–®–ï–ì–û –°–û–û–ë–©–ï–ù–ò–Ø*

üìù *–¢–µ–∫—Å—Ç:* "{user_text[:100]}..."

üéØ *–¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:* {sentiment} {emoji}

üí° *–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:*
{advice}

üìä *–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:*
‚Ä¢ –û—Ü–µ–Ω–∏—Ç—å —Ç–æ—á–Ω–µ–µ: /mood
‚Ä¢ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: –∫–Ω–æ–ø–∫–∞ üßò
‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: üìà
‚Ä¢ –ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π: üí¨
        """
        
        await update.message.reply_text(
            response,
            reply_markup=get_main_keyboard(),
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ analyze_mood_text: {e}")

# ============ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´ ============

async def log_mood_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /mood"""
    await handle_mood_button(update, context)

async def start_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /chat"""
    await handle_ai_chat_button(update, context)

async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /stats"""
    await handle_stats_button(update, context)

async def handle_crisis_situation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /crisis"""
    try:
        text = """
üö® *–≠–ö–°–¢–†–ï–ù–ù–ê–Ø –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ê–Ø –ü–û–ú–û–©–¨*

üìû *–¢–µ–ª–µ—Ñ–æ–Ω—ã –¥–æ–≤–µ—Ä–∏—è (–†–æ—Å—Å–∏—è, –±–µ—Å–ø–ª–∞—Ç–Ω–æ, 24/7):*
‚Ä¢ `8-800-2000-122` ‚Äî –ï–¥–∏–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è
‚Ä¢ `8-800-333-44-34` ‚Äî –ö—Ä–∏–∑–∏—Å–Ω–∞—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å
‚Ä¢ `112` ‚Äî –ï–¥–∏–Ω—ã–π –Ω–æ–º–µ—Ä —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã—Ö —Å–ª—É–∂–±

üåê *–û–Ω–ª–∞–π–Ω - —Ä–µ—Å—É—Ä—Å—ã:*
‚Ä¢ –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å –ú–ß–°: `8-499-216-50-50`
‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è –¥–ª—è –∂–µ–Ω—â–∏–Ω: `8-800-700-06-00`
‚Ä¢ –î–µ—Ç—Å–∫–∏–π —Ç–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è: `8-800-2000-122`

ü§ù *–ß–∞—Ç-–±–æ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ Telegram:*
‚Ä¢ @CrisisBot_ru ‚Äî –ö—Ä–∏–∑–∏—Å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫
‚Ä¢ @PsyHelpBot ‚Äî –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–º–æ—â—å
‚Ä¢ @SupportBot ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ —Ç—Ä—É–¥–Ω—É—é –º–∏–Ω—É—Ç—É

üè• *–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ —Å—Ä–æ—á–Ω–∞—è –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –ø–æ–º–æ—â—å:*
1. –í—ã–∑–æ–≤–∏—Ç–µ —Å–∫–æ—Ä—É—é –ø–æ–º–æ—â—å: `103`
2. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –±–ª–∏–∂–∞–π—à—É—é –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫—É
3. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–º–æ—â–∏ —É –±–ª–∏–∑–∫–∏—Ö –ª—é–¥–µ–π

üíñ *–í—ã –Ω–µ –æ–¥–Ω–∏:*
‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥—Ä—É–≥—É –∏–ª–∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫—É
‚Ä¢ –í—ã–π–¥–∏—Ç–µ –Ω–∞ –ø—Ä–æ–≥—É–ª–∫—É, –ø–æ–¥—ã—à–∏—Ç–µ —Å–≤–µ–∂–∏–º –≤–æ–∑–¥—É—Ö–æ–º
‚Ä¢ –ü–æ–º–Ω–∏—Ç–µ ‚Äî —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ

üåà *–í–∞—à–∞ –∂–∏–∑–Ω—å –±–µ—Å—Ü–µ–Ω–Ω–∞!*
*–ü–æ–º–æ—â—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å–µ–≥–¥–∞ ‚Äî –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è!*
        """
        
        await update.message.reply_text(
            text,
            parse_mode='Markdown'
        )
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_crisis_situation: {e}")

async def handle_unknown(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã"""
    try:
        await update.message.reply_text(
            "‚ùì *–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞*\n\n"
            "üéÆ *–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã:*\n"
            "‚Ä¢ /start ‚Äî –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
            "‚Ä¢ /help ‚Äî –ü–æ–º–æ—â—å –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏\n"
            "‚Ä¢ /mood ‚Äî –û—Ü–µ–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è\n"
            "‚Ä¢ /stats ‚Äî –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
            "‚Ä¢ /chat ‚Äî –ß–∞—Ç —Å –ò–ò\n"
            "‚Ä¢ /crisis ‚Äî –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å\n\n"
            "üí° *–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –æ —Å–≤–æ–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏!*",
            reply_markup=get_main_keyboard(),
            parse_mode='Markdown'
        )
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ handle_unknown: {e}")

# ============ –≠–ö–°–ü–û–†–¢ ============

__all__ = [
    'start',
    'show_help', 
    'handle_text_message',
    'handle_mood_button',
    'handle_ai_chat_button',
    'handle_exercises_button',
    'handle_stats_button',
    'handle_settings_button',
    'handle_back_button',
    'log_mood_command',
    'start_chat',
    'show_stats',
    'handle_crisis_situation',
    'handle_unknown'
]
